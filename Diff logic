// ---------------------------
//  dto/diff/FieldDiffDto.java
// ----------------------------

package com.tcs.fincore.CommonRequestService.dto.diff;

import lombok.*;

@Getter
@Setter
@AllArgsConstructor
@NoArgsConstructor
@Builder
public class FieldDiffDto {

    private String field;      // field name
    private Object oldValue;   // value from DB
    private Object newValue;   // value from request
    private boolean changed;   // true if different
}


// ------------------------------------
// dto/diff/RequestDiffResponseDto.java
// -------------------------------------

package com.tcs.fincore.CommonRequestService.dto.diff;

import lombok.*;

import java.util.List;

@Getter
@Setter
@AllArgsConstructor
@NoArgsConstructor
@Builder
public class RequestDiffResponseDto {

    private String changeType;           // UPDATE
    private String requestId;
    private List<FieldDiffDto> templateDiffs;
}



// ------------------------------------------
// service/diff/ReportTemplateDiffEngine.java
// ------------------------------------------

package com.tcs.fincore.CommonRequestService.service.diff;

import com.tcs.fincore.CommonRequestService.dto.ReportTemplateDto;
import com.tcs.fincore.CommonRequestService.dto.diff.*;

import java.util.*;
import java.util.stream.Collectors;

/**
 * ⭐ CENTRAL DIFF ENGINE
 * Compares FULL report: meta, data, variants, params, rules
 */
public class ReportTemplateDiffEngine {

    public static List<SectionDiffDto> diff(
            ReportTemplateDto oldDto,
            ReportTemplateDto newDto
    ) {
        List<SectionDiffDto> diffs = new ArrayList<>();

        // ================= TEMPLATE =================
        diffs.add(diffTemplateMeta(oldDto.getTemplate(), newDto.getTemplate()));
        diffs.add(diffReportMeta(oldDto.getTemplate(), newDto.getTemplate()));
        diffs.addAll(diffReportData(oldDto.getTemplate(), newDto.getTemplate()));

        // ================= VARIANTS =================
        diffs.addAll(diffVariants(oldDto.getVariants(), newDto.getVariants()));

        return diffs.stream()
                .filter(d -> d.getFields() != null && !d.getFields().isEmpty())
                .toList();
    }

    /* ================= TEMPLATE META ================= */

    private static SectionDiffDto diffTemplateMeta(
            ReportTemplateDto.Template oldT,
            ReportTemplateDto.Template newT
    ) {
        return SectionDiffDto.builder()
                .section("TEMPLATE_META")
                .fields(compareObjects(oldT.getTemplateMeta(), newT.getTemplateMeta()))
                .build();
    }

    /* ================= REPORT META ================= */

    private static SectionDiffDto diffReportMeta(
            ReportTemplateDto.Template oldT,
            ReportTemplateDto.Template newT
    ) {
        return SectionDiffDto.builder()
                .section("REPORT_META")
                .fields(compareObjects(oldT.getReportMeta(), newT.getReportMeta()))
                .build();
    }

    /* ================= REPORT DATA ================= */

    private static List<SectionDiffDto> diffReportData(
            ReportTemplateDto.Template oldT,
            ReportTemplateDto.Template newT
    ) {
        List<SectionDiffDto> result = new ArrayList<>();

        result.addAll(diffById(
                "COLUMN",
                oldT.getReportData().getColumns(),
                newT.getReportData().getColumns(),
                ReportTemplateDto.ColumnDefinition::getId
        ));

        result.addAll(diffById(
                "ROW",
                oldT.getReportData().getRows(),
                newT.getReportData().getRows(),
                ReportTemplateDto.Row::getId
        ));

        return result;
    }

    /* ================= VARIANTS ================= */

    private static List<SectionDiffDto> diffVariants(
            List<ReportTemplateVariantDto> oldVariants,
            List<ReportTemplateVariantDto> newVariants
    ) {
        return diffById(
                "VARIANT",
                oldVariants,
                newVariants,
                ReportTemplateVariantDto::getVariantCode
        );
    }

    /* ================= GENERIC HELPERS ================= */

    private static <T> List<SectionDiffDto> diffById(
            String section,
            List<T> oldList,
            List<T> newList,
            Function<T, String> keyExtractor
    ) {
        Map<String, T> oldMap = oldList == null ? Map.of()
                : oldList.stream().collect(Collectors.toMap(keyExtractor, Function.identity()));

        Map<String, T> newMap = newList == null ? Map.of()
                : newList.stream().collect(Collectors.toMap(keyExtractor, Function.identity()));

        Set<String> keys = new HashSet<>();
        keys.addAll(oldMap.keySet());
        keys.addAll(newMap.keySet());

        List<SectionDiffDto> result = new ArrayList<>();

        for (String key : keys) {
            T oldObj = oldMap.get(key);
            T newObj = newMap.get(key);

            if (!Objects.equals(oldObj, newObj)) {
                result.add(
                        SectionDiffDto.builder()
                                .section(section)
                                .identifier(key)
                                .fields(compareObjects(oldObj, newObj))
                                .build()
                );
            }
        }
        return result;
    }

    private static <T> List<FieldDiffDto> compareObjects(T oldObj, T newObj) {
        List<FieldDiffDto> diffs = new ArrayList<>();

        if (oldObj == null || newObj == null) {
            diffs.add(FieldDiffDto.builder()
                    .field("OBJECT")
                    .oldValue(oldObj)
                    .newValue(newObj)
                    .changed(true)
                    .build());
            return diffs;
        }

        for (Field f : oldObj.getClass().getDeclaredFields()) {
            f.setAccessible(true);
            try {
                Object oldVal = f.get(oldObj);
                Object newVal = f.get(newObj);

                if (!Objects.equals(oldVal, newVal)) {
                    diffs.add(FieldDiffDto.builder()
                            .field(f.getName())
                            .oldValue(oldVal)
                            .newValue(newVal)
                            .changed(true)
                            .build());
                }
            } catch (Exception ignored) {}
        }
        return diffs;
    }
}

// ---‐--------‐-----------------------
// service/RequestDiffService.java
// -----------------------------------

package com.tcs.fincore.CommonRequestService.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.tcs.fincore.CommonRequestService.dto.ReportTemplateDto;
import com.tcs.fincore.CommonRequestService.dto.diff.RequestDiffResponseDto;
import com.tcs.fincore.CommonRequestService.model.CommonReq;
import com.tcs.fincore.CommonRequestService.model.ReportTemplate;
import com.tcs.fincore.CommonRequestService.repository.CommonRequestRepository;
import com.tcs.fincore.CommonRequestService.repository.ReportTemplateRepository;
import com.tcs.fincore.CommonRequestService.service.diff.TemplateDiffUtil;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class RequestDiffService {

    private final CommonRequestRepository commonRequestRepository;
    private final ReportTemplateRepository reportTemplateRepository;
    private final ObjectMapper objectMapper;

    public RequestDiffResponseDto getDiff(Long requestId) throws Exception {

        // ⭐ Fetch request
        CommonReq req = commonRequestRepository.findById(requestId)
                .orElseThrow(() -> new RuntimeException("Request not found"));

        if (!"UPDATE".equals(req.getChangeType().name())) {
            throw new IllegalStateException("Diff available only for UPDATE");
        }

        // ⭐ Fetch ACTIVE template (OLD)
        ReportTemplate activeTemplate =
                reportTemplateRepository
                        .findFirstByReportIdAndStatus(req.getTargetId(), "ACTIVE")
                        .orElseThrow(() -> new RuntimeException("Active template not found"));

        // ⭐ Deserialize OLD + NEW
        ReportTemplateDto.Template oldTemplate =
                objectMapper.readValue(activeTemplate.getTemplateJson(),
                        ReportTemplateDto.Template.class);

        ReportTemplateDto newPayload =
                objectMapper.readValue(req.getPayload(), ReportTemplateDto.class);

        return RequestDiffResponseDto.builder()
                .requestId(String.valueOf(requestId))
                .changeType("UPDATE")
                .templateDiffs(
                        TemplateDiffUtil.compare(
                                oldTemplate,
                                newPayload.getTemplate()
                        )
                )
                .build();
    }
}



// --------------------------------------
// controller/RequestDiffController.java
// --------------------------------------

package com.tcs.fincore.CommonRequestService.controller;

import com.tcs.fincore.CommonRequestService.dto.diff.RequestDiffResponseDto;
import com.tcs.fincore.CommonRequestService.service.RequestDiffService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api")
@RequiredArgsConstructor
public class RequestDiffController {

    private final RequestDiffService diffService;

    /**
     * ⭐ COMMENT:
     * Used by checker to view OLD vs NEW data
     */
    @GetMapping("/request-diff/{requestId}")
    public RequestDiffResponseDto getDiff(@PathVariable Long requestId)
            throws Exception {
        return diffService.getDiff(requestId);
    }
}
