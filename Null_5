import React, { useEffect, useState, useMemo, memo, useRef } from "react";
import {
  Dialog, DialogTitle, DialogContent, Box, Typography, Table, TableBody, 
  TableCell, TableRow, Paper, CircularProgress, IconButton, Divider, 
  Stack, TableHead, TableContainer, Chip, Switch, FormControlLabel
} from "@mui/material";
import { Close, TableChart } from "@mui/icons-material";
import { useVirtualizer } from '@tanstack/react-virtual';
import useApi from "../../hooks/useApi";

// Helper to render differences in text/objects
const DiffValue = memo(({ value, type }) => {
  if (value === null || value === undefined) return <Typography variant="caption" color="text.disabled">N/A</Typography>;
  const displayValue = typeof value === 'object' ? JSON.stringify(value, null, 2) : String(value);
  
  return (
    <Typography 
      variant="body2" 
      sx={{ 
        color: type === 'old' ? 'error.main' : 'success.main',
        bgcolor: type === 'old' ? '#fff5f5' : '#f5fff5',
        p: 0.5, borderRadius: 1, fontSize: '0.75rem', wordBreak: 'break-all'
      }}
    >
      {displayValue}
    </Typography>
  );
});

// Virtualized Grid Component for Side-by-Side View
const VirtualizedGrid = ({ rows, maxCols, side, cellDiffs, columnDiffs, scrollRef, onScroll }) => {
  const parentRef = useRef();

  const rowVirtualizer = useVirtualizer({
    count: rows.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 45, // Estimated row height
    overscan: 10,
  });

  return (
    <TableContainer 
      ref={(el) => { parentRef.current = el; if(scrollRef) scrollRef.current = el; }} 
      onScroll={onScroll}
      sx={{ maxHeight: 600, border: "1px solid #e0e0e0", overflow: 'auto' }}
    >
      <Table size="small" stickyHeader sx={{ width: 'max-content', tableLayout: 'fixed' }}>
        <TableHead>
          <TableRow>
            <TableCell sx={{ width: 50, bgcolor: '#f5f5f5' }}>#</TableCell>
            {Array.from({ length: maxCols }).map((_, i) => {
                const colKey = `C${i}`; // Simplified key logic based on index
                const isModified = !!columnDiffs?.[colKey];
                return (
                    <TableCell key={i} sx={{ width: 150, bgcolor: isModified ? '#fffde7' : '#f5f5f5' }}>
                        Col {i+1} {isModified && <Chip label="MOD" size="small" color="warning" sx={{ height: 16, fontSize: '0.6rem' }}/>}
                    </TableCell>
                );
            })}
          </TableRow>
        </TableHead>
        <TableBody style={{ height: `${rowVirtualizer.getTotalSize()}px`, position: 'relative' }}>
          {rowVirtualizer.getVirtualItems().map((virtualRow) => {
            const row = rows[virtualRow.index];
            return (
              <TableRow 
                key={virtualRow.key}
                style={{ position: 'absolute', top: 0, left: 0, width: '100%', transform: `translateY(${virtualRow.start}px)` }}
              >
                <TableCell sx={{ width: 50 }}>{virtualRow.index + 1}</TableCell>
                {row.cells?.map((cell, cIdx) => {
                  const cellKey = cell.id || `R${virtualRow.index}C${cIdx}`;
                  const isModified = !!cellDiffs?.[cellKey];
                  return (
                    <TableCell 
                        key={cIdx} 
                        sx={{ 
                            width: 150, 
                            bgcolor: isModified ? (side === 'old' ? '#ffebee' : '#e8f5e9') : 'inherit' 
                        }}
                    >
                      {cell.value || cell.expression || "-"}
                    </TableCell>
                  );
                })}
              </TableRow>
            );
          })}
        </TableBody>
      </Table>
    </TableContainer>
  );
};

const CompareTemplateDialog = ({ open, onClose, requestRow }) => {
  const { callApi } = useApi();
  const [loading, setLoading] = useState(false);
  const [diffResponse, setDiffResponse] = useState(null);
  const [checkerMode, setCheckerMode] = useState(true); // Default to Checker View (Modified only)

  const leftRef = useRef(null);
  const rightRef = useRef(null);

  useEffect(() => {
    if (open && requestRow?.id) {
      setLoading(true);
      callApi("/TC/template-diff", { requestId: requestRow.id }, "POST")
        .then((res) => setDiffResponse(res.data || res))
        .catch(console.error)
        .finally(() => setLoading(false));
    }
  }, [open, requestRow, callApi]);

  const handleScroll = (e) => {
    const { scrollTop, scrollLeft } = e.target;
    if (e.target === leftRef.current && rightRef.current) {
      rightRef.current.scrollTop = scrollTop;
      rightRef.current.scrollLeft = scrollLeft;
    } else if (e.target === rightRef.current && leftRef.current) {
      leftRef.current.scrollTop = scrollTop;
      leftRef.current.scrollLeft = scrollLeft;
    }
  };

  const gridData = useMemo(() => {
    if (!diffResponse) return null;
    const oldRows = diffResponse.oldTemplate?.template?.reportData?.rows || [];
    const newRows = diffResponse.newTemplate?.template?.reportData?.rows || [];
    const maxCols = Math.max(
        diffResponse.oldTemplate?.template?.reportData?.columns?.length || 0,
        diffResponse.newTemplate?.template?.reportData?.columns?.length || 0
    );
    return { oldRows, newRows, maxCols };
  }, [diffResponse]);

  return (
    <Dialog open={open} onClose={onClose} maxWidth="xl" fullWidth>
      <DialogTitle sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', bgcolor: '#f8f9fa' }}>
        <Stack direction="row" spacing={2} alignItems="center">
          <TableChart color="primary" />
          <Typography variant="h6">Compare Template Structures</Typography>
          <FormControlLabel
            sx={{ ml: 4 }}
            control={<Switch checked={checkerMode} onChange={(e) => setCheckerMode(e.target.checked)} />}
            label="Checker View (Modified Only)"
          />
        </Stack>
        <IconButton onClick={onClose}><Close /></IconButton>
      </DialogTitle>

      <DialogContent sx={{ p: 2 }}>
        {loading ? (
          <Box sx={{ display: 'flex', justifyContent: 'center', py: 10 }}><CircularProgress /></Box>
        ) : diffResponse && (
          <Stack spacing={3}>
            {/* COLUMN DEFINITION CHANGES */}
            <Box>
                <Typography variant="subtitle2" color="primary" gutterBottom fontWeight="bold">1. Column Definition Diffs</Typography>
                <TableContainer component={Paper} variant="outlined">
                    <Table size="small">
                        <TableHead sx={{ bgcolor: '#eee' }}>
                            <TableRow>
                                <TableCell>Column Key</TableCell>
                                <TableCell>Property</TableCell>
                                <TableCell>Old Value</TableCell>
                                <TableCell>New Value</TableCell>
                            </TableRow>
                        </TableHead>
                        <TableBody>
                            {Object.entries(diffResponse.columnDiffs || {}).length > 0 ? (
                                Object.entries(diffResponse.columnDiffs).map(([colId, fields]) => 
                                    Object.entries(fields).map(([field, diff], idx) => (
                                        <TableRow key={`${colId}-${field}`}>
                                            {idx === 0 && <TableCell rowSpan={Object.keys(fields).length} sx={{ fontWeight: 'bold' }}>{colId}</TableCell>}
                                            <TableCell>{field}</TableCell>
                                            <TableCell><DiffValue value={diff.oldValue} type="old" /></TableCell>
                                            <TableCell><DiffValue value={diff.newValue} type="new" /></TableCell>
                                        </TableRow>
                                    ))
                                )
                            ) : (
                                <TableRow><TableCell colSpan={4} align="center">No column structural changes</TableCell></TableRow>
                            )}
                        </TableBody>
                    </Table>
                </TableContainer>
            </Box>

            {/* CELL CHANGES */}
            <Box>
                <Typography variant="subtitle2" color="primary" gutterBottom fontWeight="bold">2. Template Data Comparison</Typography>
                
                {checkerMode ? (
                    // CHECKER VIEW: MODIFIED FIELDS ONLY
                    <TableContainer component={Paper} variant="outlined">
                        <Table size="small">
                            <TableHead sx={{ bgcolor: '#eee' }}>
                                <TableRow>
                                    <TableCell>Cell Location/ID</TableCell>
                                    <TableCell>Field</TableCell>
                                    <TableCell>Old Value (Current Active)</TableCell>
                                    <TableCell>New Value (Pending Request)</TableCell>
                                </TableRow>
                            </TableHead>
                            <TableBody>
                                {Object.entries(diffResponse.cellDiffs || {}).map(([cellId, fields]) => 
                                    Object.entries(fields).map(([field, diff], idx) => (
                                        <TableRow key={`${cellId}-${field}`}>
                                            {idx === 0 && <TableCell rowSpan={Object.keys(fields).length} sx={{ fontWeight: 'bold' }}>{cellId}</TableCell>}
                                            <TableCell sx={{ textTransform: 'capitalize' }}>{field}</TableCell>
                                            <TableCell><DiffValue value={diff.oldValue} type="old" /></TableCell>
                                            <TableCell><DiffValue value={diff.newValue} type="new" /></TableCell>
                                        </TableRow>
                                    ))
                                )}
                            </TableBody>
                        </Table>
                    </TableContainer>
                ) : (
                    // FULL TEMPLATE VIEW: SIDE-BY-SIDE VIRTUALIZED GRIDS
                    <Stack direction="row" spacing={1}>
                        <Box sx={{ flex: 1 }}>
                            <Typography variant="caption" display="block" textAlign="center" fontWeight="bold">OLD VERSION</Typography>
                            <VirtualizedGrid 
                                rows={gridData.oldRows} maxCols={gridData.maxCols} side="old"
                                cellDiffs={diffResponse.cellDiffs} columnDiffs={diffResponse.columnDiffs}
                                scrollRef={leftRef} onScroll={handleScroll}
                            />
                        </Box>
                        <Box sx={{ flex: 1 }}>
                            <Typography variant="caption" display="block" textAlign="center" fontWeight="bold">NEW VERSION</Typography>
                            <VirtualizedGrid 
                                rows={gridData.newRows} maxCols={gridData.maxCols} side="new"
                                cellDiffs={diffResponse.cellDiffs} columnDiffs={diffResponse.columnDiffs}
                                scrollRef={rightRef} onScroll={handleScroll}
                            />
                        </Box>
                    </Stack>
                )}
            </Box>
          </Stack>
        )}
      </DialogContent>
    </Dialog>
  );
};

export default CompareTemplateDialog;
