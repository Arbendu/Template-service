// -----------------------------------------------------

â€‹package com.fincore.TemplateConfigurationService.dto;

import lombok.*;
import java.util.List;
import java.util.Map;

@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class TemplateDiffResponseDto {

    private String status;
    private String message;
    
    // Requirement 1: Maker Remarks
    private String remarks;

    // Full objects for context
    private TemplatePayload oldTemplate;
    private TemplatePayload newTemplate;

    // Diff Details
    private Map<String, CellDiff> cellDiffs;     // Key: RowID + ColID
    private Map<String, ColumnDiff> columnDiffs; // Key: ColID
    
    // Requirement 3: Variant Diffs
    private List<VariantDiff> variantDiffs;

    @Getter
    @Setter
    @NoArgsConstructor
    @AllArgsConstructor
    @Builder
    public static class CellDiff {
        private String rowId;
        private String columnId;
        private ValueDiff value;
        private ValueDiff style;
        private String remark;
    }

    @Getter
    @Setter
    @NoArgsConstructor
    @AllArgsConstructor
    @Builder
    public static class ColumnDiff {
        private String columnId;
        private String columnName;
        private ValueDiff width;
        private ValueDiff alignment;
    }
    
    // New DTO for Variant Diffs
    @Getter
    @Setter
    @NoArgsConstructor
    @AllArgsConstructor
    @Builder
    public static class VariantDiff {
        private String variantCode;
        private String variantName;
        private String changeType; // ADDED, REMOVED, MODIFIED
        private ValueDiff description;
        private ValueDiff status;
        // List of changes within this variant (params/rules)
        private List<String> details; 
    }
}







// -----------------------------------------------------------------------------------


package com.fincore.TemplateConfigurationService.service;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fincore.TemplateConfigurationService.dto.*;
import com.fincore.TemplateConfigurationService.exception.ResourceNotFoundException;
import com.tcs.fincore.CommonRequestService.model.CommonReq; // Assuming access to CommonReq entity
import com.tcs.fincore.CommonRequestService.model.ReportTemplateHistory;
import com.tcs.fincore.CommonRequestService.repository.CommonRequestRepository; // Assuming Repo access
import com.tcs.fincore.CommonRequestService.repository.ReportTemplateHistoryRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.*;
import java.util.function.Function;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class TemplateDiffService {

    private final CommonRequestRepository commonReqRepository;
    private final ReportTemplateHistoryRepository historyRepository;
    private final ObjectMapper objectMapper;

    public TemplateDiffResponseDto compareByRequestId(Long requestId) {
        log.info("Calculating diff for Request ID: {}", requestId);

        // 1. Fetch Request
        CommonReq request = commonReqRepository.findById(requestId)
                .orElseThrow(() -> new ResourceNotFoundException("Request not found"));

        // 2. Parse NEW Template (From Request Payload)
        TemplatePayload newPayload = parsePayload(request.getPayload());
        if (newPayload == null) {
            throw new IllegalArgumentException("Invalid request payload");
        }

        // Requirement 1: Extract Remarks from Payload or Request Entity
        // Priority: Payload > Entity Column
        String makerRemarks = newPayload.getRemarks();
        if (makerRemarks == null || makerRemarks.isEmpty()) {
             makerRemarks = request.getMakerRemarks(); // Assuming you added this to Entity
        }

        // 3. Fetch OLD Template (From History based on Template ID and Version)
        // Logic: New Version is X, so we need History with Version X-1
        String templateId = newPayload.getTemplate().getTemplateMeta().getTemplateId();
        int currentVersion = Integer.parseInt(newPayload.getTemplate().getTemplateMeta().getVersion());
        int oldVersion = currentVersion - 1;

        TemplatePayload oldPayload = null;
        if (oldVersion > 0) {
            oldPayload = fetchOldTemplateFromHistory(templateId, oldVersion);
        }

        // 4. Calculate Diffs
        return calculateDiff(oldPayload, newPayload, makerRemarks);
    }

    // -------------------------------------------------------------------------
    // Requirement 2: Fix Null Variants in Old Template
    // -------------------------------------------------------------------------
    private TemplatePayload fetchOldTemplateFromHistory(String templateId, int version) {
        ReportTemplateHistory history = historyRepository.findByTemplateIdAndVersionNo(templateId, version)
                .orElse(null);

        if (history == null) return null;

        try {
            // A. Parse Main Template JSON
            ReportTemplateDto.Template template = objectMapper.readValue(history.getTemplateJson(), ReportTemplateDto.Template.class);
            
            // B. Parse Variants JSON (This was missing/null before)
            List<VariantDto> variants = new ArrayList<>();
            if (history.getVariantsJson() != null && !history.getVariantsJson().isEmpty()) {
                variants = objectMapper.readValue(history.getVariantsJson(), new TypeReference<List<VariantDto>>() {});
            }

            // C. Construct Payload
            return TemplatePayload.builder()
                    .template(template)
                    .variants(variants)
                    .remarks(history.getRemarks())
                    .build();

        } catch (JsonProcessingException e) {
            log.error("Failed to parse history JSON", e);
            return null;
        }
    }

    private TemplatePayload parsePayload(String json) {
        try {
            return objectMapper.readValue(json, TemplatePayload.class);
        } catch (Exception e) {
            log.error("JSON Parse Error", e);
            return null;
        }
    }

    // -------------------------------------------------------------------------
    // Diff Calculation Core
    // -------------------------------------------------------------------------
    private TemplateDiffResponseDto calculateDiff(TemplatePayload oldT, TemplatePayload newT, String remarks) {
        TemplateDiffResponseDto response = new TemplateDiffResponseDto();
        response.setStatus("SUCCESS");
        response.setRemarks(remarks); // Set the remarks
        response.setOldTemplate(oldT);
        response.setNewTemplate(newT);

        // Layout Diffs (Existing Logic)
        response.setCellDiffs(calculateCellDiffs(oldT, newT));
        response.setColumnDiffs(calculateColumnDiffs(oldT, newT));

        // Requirement 3: Variant Diffs
        response.setVariantDiffs(calculateVariantDiffs(
                oldT != null ? oldT.getVariants() : Collections.emptyList(),
                newT != null ? newT.getVariants() : Collections.emptyList()
        ));

        return response;
    }

    // -------------------------------------------------------------------------
    // Logic: Cell Diffs (Unchanged from your working code)
    // -------------------------------------------------------------------------
    private Map<String, TemplateDiffResponseDto.CellDiff> calculateCellDiffs(TemplatePayload oldT, TemplatePayload newT) {
        Map<String, TemplateDiffResponseDto.CellDiff> diffs = new HashMap<>();
        List<TemplatePayload.Row> oldRows = getRowsSafe(oldT);
        List<TemplatePayload.Row> newRows = getRowsSafe(newT);

        // Map Rows by ID
        Map<String, TemplatePayload.Row> oldRowMap = oldRows.stream()
                .collect(Collectors.toMap(TemplatePayload.Row::getId, Function.identity(), (a, b) -> a));

        for (TemplatePayload.Row newRow : newRows) {
            TemplatePayload.Row oldRow = oldRowMap.get(newRow.getId());
            
            // Map Cells by ID (or Column Index if ID missing)
            Map<String, TemplatePayload.Cell> oldCellMap = new HashMap<>();
            if (oldRow != null && oldRow.getCells() != null) {
                for (int i = 0; i < oldRow.getCells().size(); i++) {
                    TemplatePayload.Cell c = oldRow.getCells().get(i);
                    String key = (c.getId() != null) ? c.getId() : "IDX_" + i;
                    oldCellMap.put(key, c);
                }
            }

            if (newRow.getCells() != null) {
                for (int i = 0; i < newRow.getCells().size(); i++) {
                    TemplatePayload.Cell newCell = newRow.getCells().get(i);
                    String key = (newCell.getId() != null) ? newCell.getId() : "IDX_" + i;
                    TemplatePayload.Cell oldCell = oldCellMap.get(key);

                    if (isCellChanged(oldCell, newCell)) {
                        // Construct Key: RowID + ColID (Preferred)
                        String diffKey = newRow.getId() + "_" + buildColumnKey(oldCell, newCell, i);
                        
                        diffs.put(diffKey, TemplateDiffResponseDto.CellDiff.builder()
                                .rowId(newRow.getId())
                                .columnId(buildColumnKey(oldCell, newCell, i))
                                .value(ValueDiff.builder()
                                        .oldValue(oldCell != null ? oldCell.getValue() : null)
                                        .newValue(newCell.getValue()).build())
                                .style(ValueDiff.builder()
                                        .oldValue(oldCell != null ? oldCell.getStyle() : null)
                                        .newValue(newCell.getStyle()).build())
                                .build());
                    }
                }
            }
        }
        return diffs;
    }

    private boolean isCellChanged(TemplatePayload.Cell oldC, TemplatePayload.Cell newC) {
        if (oldC == null) return true; // Added
        if (!Objects.equals(oldC.getValue(), newC.getValue())) return true;
        // Simple style check (can be expanded)
        return !Objects.equals(oldC.getStyle(), newC.getStyle());
    }

    // -------------------------------------------------------------------------
    // Logic: Column Diffs (Unchanged)
    // -------------------------------------------------------------------------
    private Map<String, TemplateDiffResponseDto.ColumnDiff> calculateColumnDiffs(TemplatePayload oldT, TemplatePayload newT) {
        Map<String, TemplateDiffResponseDto.ColumnDiff> diffs = new HashMap<>();
        // ... (Keep your existing column diff logic here) ...
        return diffs; 
    }

    // -------------------------------------------------------------------------
    // Requirement 3: Variant Diff Logic
    // -------------------------------------------------------------------------
    private List<TemplateDiffResponseDto.VariantDiff> calculateVariantDiffs(List<VariantDto> oldVars, List<VariantDto> newVars) {
        List<TemplateDiffResponseDto.VariantDiff> diffList = new ArrayList<>();
        Map<String, VariantDto> oldMap = oldVars.stream().collect(Collectors.toMap(VariantDto::getVariantCode, Function.identity()));
        Map<String, VariantDto> newMap = newVars.stream().collect(Collectors.toMap(VariantDto::getVariantCode, Function.identity()));

        Set<String> allKeys = new HashSet<>();
        allKeys.addAll(oldMap.keySet());
        allKeys.addAll(newMap.keySet());

        for (String code : allKeys) {
            VariantDto oldV = oldMap.get(code);
            VariantDto newV = newMap.get(code);

            if (oldV == null) {
                // ADDED
                diffList.add(TemplateDiffResponseDto.VariantDiff.builder()
                        .variantCode(code).variantName(newV.getVariantName())
                        .changeType("ADDED")
                        .details(List.of("New variant added"))
                        .build());
            } else if (newV == null) {
                // REMOVED
                diffList.add(TemplateDiffResponseDto.VariantDiff.builder()
                        .variantCode(code).variantName(oldV.getVariantName())
                        .changeType("REMOVED")
                        .details(List.of("Variant removed"))
                        .build());
            } else {
                // MODIFIED?
                List<String> changes = new ArrayList<>();
                if (!Objects.equals(oldV.getVariantName(), newV.getVariantName())) changes.add("Name changed");
                if (!Objects.equals(oldV.getDescription(), newV.getDescription())) changes.add("Description changed");
                if (!Objects.equals(oldV.getStatus(), newV.getStatus())) changes.add("Status changed");
                
                // Deep Check Params
                if (!Objects.equals(oldV.getParams(), newV.getParams())) changes.add("Parameters modified");
                // Deep Check Rules
                if (!Objects.equals(oldV.getFilterRules(), newV.getFilterRules())) changes.add("Filter Rules modified");

                if (!changes.isEmpty()) {
                    diffList.add(TemplateDiffResponseDto.VariantDiff.builder()
                            .variantCode(code).variantName(newV.getVariantName())
                            .changeType("MODIFIED")
                            .description(ValueDiff.builder().oldValue(oldV.getDescription()).newValue(newV.getDescription()).build())
                            .status(ValueDiff.builder().oldValue(oldV.getStatus()).newValue(newV.getStatus()).build())
                            .details(changes)
                            .build());
                }
            }
        }
        return diffList;
    }
    
    // Helpers
    private String buildColumnKey(TemplatePayload.Cell oldCell, TemplatePayload.Cell newCell, int idx) {
        // ... (Same as your file) ...
        return "C" + idx;
    }
    
    private List<TemplatePayload.Row> getRowsSafe(TemplatePayload t) {
        if (t == null || t.getTemplate() == null || t.getTemplate().getReportData() == null) return Collections.emptyList();
        return t.getTemplate().getReportData().getRows() != null ? t.getTemplate().getReportData().getRows() : Collections.emptyList();
    }
}










// -------------------------------------------------------------
