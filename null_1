/**
 * Compares two lists of variants and returns a map of differences.
 * Key: Variant Code, Value: Map of field changes.
 */
public Map<String, Map<String, ValueDiff>> compareVariants(
        List<VariantDto> oldVariants,
        List<VariantDto> newVariants
) {
    Map<String, Map<String, ValueDiff>> diffs = new LinkedHashMap<>();

    // Use a Set to collect all unique variant codes from both lists
    Set<String> allCodes = new LinkedHashSet<>();
    if (oldVariants != null) oldVariants.forEach(v -> allCodes.add(v.getVariantCode()));
    if (newVariants != null) newVariants.forEach(v -> allCodes.add(v.getVariantCode()));

    for (String code : allCodes) {
        VariantDto oldV = findVariantByCode(oldVariants, code);
        VariantDto newV = findVariantByCode(newVariants, code);

        Map<String, ValueDiff> fieldDiffs = new LinkedHashMap<>();

        // 1. Compare basic fields
        compareField("variantName", 
            oldV != null ? oldV.getVariantName() : null, 
            newV != null ? newV.getVariantName() : null, fieldDiffs);
        
        compareField("description", 
            oldV != null ? oldV.getDescription() : null, 
            newV != null ? newV.getDescription() : null, fieldDiffs);
        
        compareField("status", 
            oldV != null ? oldV.getStatus() : null, 
            newV != null ? newV.getStatus() : null, fieldDiffs);

        // 2. Compare complex lists (Params and Filter Rules)
        compareField("params", 
            oldV != null ? oldV.getParams() : null, 
            newV != null ? newV.getParams() : null, fieldDiffs);
            
        compareField("filterRules", 
            oldV != null ? oldV.getFilterRules() : null, 
            newV != null ? newV.getFilterRules() : null, fieldDiffs);

        if (!fieldDiffs.isEmpty()) {
            diffs.put(code, fieldDiffs);
        }
    }
    return diffs;
}

// Helper to find a variant in the list by its code
private VariantDto findVariantByCode(List<VariantDto> list, String code) {
    if (list == null || code == null) return null;
    return list.stream()
            .filter(v -> code.equals(v.getVariantCode()))
            .findFirst()
            .orElse(null);
}
