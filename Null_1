// Json compare utill
// Inside JsonCompareUtil class

// 1. NEW METHOD: Compare Global Params
public Map<String, Map<String, ValueDiff>> compareGlobalParams(
        List<TemplatePayload.GlobalParamDef> oldParams,
        List<TemplatePayload.GlobalParamDef> newParams
) {
    Map<String, Map<String, ValueDiff>> diffs = new LinkedHashMap<>();
    Set<String> allNames = new LinkedHashSet<>();
    if (oldParams != null) oldParams.forEach(p -> allNames.add(p.getName()));
    if (newParams != null) newParams.forEach(p -> allNames.add(p.getName()));

    for (String name : allNames) {
        TemplatePayload.GlobalParamDef oldP = findParam(oldParams, name);
        TemplatePayload.GlobalParamDef newP = findParam(newParams, name);

        Map<String, ValueDiff> fieldDiffs = new LinkedHashMap<>();
        
        // Compare fields
        compareField("dataType", oldP != null ? oldP.getDataType() : null, newP != null ? newP.getDataType() : null, fieldDiffs);
        compareField("mode", oldP != null ? oldP.getMode() : null, newP != null ? newP.getMode() : null, fieldDiffs);
        compareField("expression", oldP != null ? oldP.getExpression() : null, newP != null ? newP.getExpression() : null, fieldDiffs);
        compareField("defaultValue", oldP != null ? oldP.getDefaultValue() : null, newP != null ? newP.getDefaultValue() : null, fieldDiffs);
        compareField("source", oldP != null ? oldP.getSource() : null, newP != null ? newP.getSource() : null, fieldDiffs);

        if (!fieldDiffs.isEmpty()) {
            diffs.put(name, fieldDiffs);
        }
    }
    return diffs;
}

private TemplatePayload.GlobalParamDef findParam(List<TemplatePayload.GlobalParamDef> list, String name) {
    if (list == null) return null;
    return list.stream().filter(p -> name.equals(p.getName())).findFirst().orElse(null);
}

// 2. UPDATE: compareColumnFields to include filters
private Map<String, ValueDiff> compareColumnFields(TemplatePayload.ColumnDefinition oldCol, TemplatePayload.ColumnDefinition newCol) {
    Map<String, ValueDiff> diffs = new LinkedHashMap<>();
    
    // ... existing ID/Name/Format checks ...
    compareField("id", oldCol != null ? oldCol.getId() : null, newCol != null ? newCol.getId() : null, diffs);
    compareField("name", oldCol != null ? oldCol.getName() : null, newCol != null ? newCol.getName() : null, diffs);
    compareField("format", oldCol != null ? oldCol.getFormat() : null, newCol != null ? newCol.getFormat() : null, diffs);
    
    // NEW: Compare Column Filters
    compareField("filters", 
        oldCol != null ? oldCol.getTemplateColumnFilters() : null, 
        newCol != null ? newCol.getTemplateColumnFilters() : null, 
        diffs);

    return diffs;
}















// TemplateDiffServiceImpl


// Inside compareByRequestId method
// ... after cell and column diffs ...

// Compare Global Params
Map<String, Map<String, ValueDiff>> globalParamDiffs = jsonCompareUtil.compareGlobalParams(
    oldTemplate.getTemplate().getGlobalParams(),
    newTemplate.getTemplate().getGlobalParams()
);

return TemplateDiffResponseDto.builder()
        .oldTemplate(oldTemplate)
        .newTemplate(newTemplate)
        .cellDiffs(cellDiffs)
        .columnDiffs(columnDiffs)
        .variantDiffs(variantDiffs)
        .globalParamDiffs(globalParamDiffs) // Add to response
        .build();
















//  Compare Template Dialog Screen

// Inside DiffText component...
const formatItem = (item) => {
  if (typeof item !== 'object' || item === null) return item;

  // 1. Global Param Definition
  if (item.name && item.mode) {
    return `[Param] ${item.name} (${item.dataType}) - ${item.mode}`;
  }
  // 2. Template Column Filter
  if (item.tableName && item.filters) {
    return `[Filter] Table: ${item.tableName}, Conditions: ${JSON.stringify(item.filters)}`;
  }
  // 3. Filter Rule (Existing)
  if (item.dbColumn || item.operator) return `[Rule] ${item.dbColumn} ${item.operator} ${item.scopeValue}`;
  
  // 4. Variant Param (Existing)
  if (item.paramName) return `${item.paramName}: ${item.paramValue || item.label || 'N/A'}`;

  return JSON.stringify(item);
};










// ... Inside CompareTemplateDialog return statement ...

{/* ======================================================================== */}
{/* NEW: GLOBAL PARAMETERS DIFF (Add this above or below Variants)             */}
{/* ======================================================================== */}
{diffResponse?.globalParamDiffs && Object.keys(diffResponse.globalParamDiffs).length > 0 && (
  <Paper variant="outlined" sx={{ overflow: 'hidden', borderColor: 'info.light', mt: 2 }}>
    <Box sx={{ bgcolor: alpha(theme.palette.info.main, 0.08), px: 2, py: 1.5 }}>
      <Typography variant="subtitle2" fontWeight="bold" color="text.primary">
        Global Parameter Changes
      </Typography>
    </Box>
    <TableContainer>
      <Table size="small">
        <TableHead>
          <TableRow>
            <TableCell sx={{ fontWeight: 'bold' }}>Param Name</TableCell>
            <TableCell sx={{ fontWeight: 'bold' }}>Property</TableCell>
            <TableCell sx={{ fontWeight: 'bold', color: 'error.main' }}>Old Value</TableCell>
            <TableCell sx={{ fontWeight: 'bold', color: 'success.main' }}>New Value</TableCell>
          </TableRow>
        </TableHead>
        <TableBody>
          {Object.entries(diffResponse.globalParamDiffs).flatMap(([paramName, fields]) => 
            Object.entries(fields).map(([field, diff]) => (
              <TableRow key={`${paramName}-${field}`} hover>
                <TableCell sx={{ fontWeight: 'bold', color: 'primary.main' }}>{paramName}</TableCell>
                <TableCell>{field}</TableCell>
                <TableCell sx={{ bgcolor: alpha(theme.palette.error.main, 0.02) }}>
                  <DiffText value={diff.oldValue} otherValue={diff.newValue} type="old" />
                </TableCell>
                <TableCell sx={{ bgcolor: alpha(theme.palette.success.main, 0.02) }}>
                  <DiffText value={diff.newValue} otherValue={diff.oldValue} type="new" />
                </TableCell>
              </TableRow>
            ))
          )}
        </TableBody>
      </Table>
    </TableContainer>
  </Paper>
)}
