// Json compare utill
// Inside JsonCompareUtil class

// 1. NEW METHOD: Compare Global Params
public Map<String, Map<String, ValueDiff>> compareGlobalParams(
        List<TemplatePayload.GlobalParamDef> oldParams,
        List<TemplatePayload.GlobalParamDef> newParams
) {
    Map<String, Map<String, ValueDiff>> diffs = new LinkedHashMap<>();
    Set<String> allNames = new LinkedHashSet<>();
    if (oldParams != null) oldParams.forEach(p -> allNames.add(p.getName()));
    if (newParams != null) newParams.forEach(p -> allNames.add(p.getName()));

    for (String name : allNames) {
        TemplatePayload.GlobalParamDef oldP = findParam(oldParams, name);
        TemplatePayload.GlobalParamDef newP = findParam(newParams, name);

        Map<String, ValueDiff> fieldDiffs = new LinkedHashMap<>();
        
        // Compare fields
        compareField("dataType", oldP != null ? oldP.getDataType() : null, newP != null ? newP.getDataType() : null, fieldDiffs);
        compareField("mode", oldP != null ? oldP.getMode() : null, newP != null ? newP.getMode() : null, fieldDiffs);
        compareField("expression", oldP != null ? oldP.getExpression() : null, newP != null ? newP.getExpression() : null, fieldDiffs);
        compareField("defaultValue", oldP != null ? oldP.getDefaultValue() : null, newP != null ? newP.getDefaultValue() : null, fieldDiffs);
        compareField("source", oldP != null ? oldP.getSource() : null, newP != null ? newP.getSource() : null, fieldDiffs);

        if (!fieldDiffs.isEmpty()) {
            diffs.put(name, fieldDiffs);
        }
    }
    return diffs;
}

private TemplatePayload.GlobalParamDef findParam(List<TemplatePayload.GlobalParamDef> list, String name) {
    if (list == null) return null;
    return list.stream().filter(p -> name.equals(p.getName())).findFirst().orElse(null);
}

// 2. UPDATE: compareColumnFields to include filters
private Map<String, ValueDiff> compareColumnFields(TemplatePayload.ColumnDefinition oldCol, TemplatePayload.ColumnDefinition newCol) {
    Map<String, ValueDiff> diffs = new LinkedHashMap<>();
    
    // ... existing ID/Name/Format checks ...
    compareField("id", oldCol != null ? oldCol.getId() : null, newCol != null ? newCol.getId() : null, diffs);
    compareField("name", oldCol != null ? oldCol.getName() : null, newCol != null ? newCol.getName() : null, diffs);
    compareField("format", oldCol != null ? oldCol.getFormat() : null, newCol != null ? newCol.getFormat() : null, diffs);
    
    // NEW: Compare Column Filters
    compareField("filters", 
        oldCol != null ? oldCol.getTemplateColumnFilters() : null, 
        newCol != null ? newCol.getTemplateColumnFilters() : null, 
        diffs);

    return diffs;
}















// TemplateDiffServiceImpl


// Inside compareByRequestId method
// ... after cell and column diffs ...

// Compare Global Params
Map<String, Map<String, ValueDiff>> globalParamDiffs = jsonCompareUtil.compareGlobalParams(
    oldTemplate.getTemplate().getGlobalParams(),
    newTemplate.getTemplate().getGlobalParams()
);

return TemplateDiffResponseDto.builder()
        .oldTemplate(oldTemplate)
        .newTemplate(newTemplate)
        .cellDiffs(cellDiffs)
        .columnDiffs(columnDiffs)
        .variantDiffs(variantDiffs)
        .globalParamDiffs(globalParamDiffs) // Add to response
        .build();
















//  Compare Template Dialog Screen

