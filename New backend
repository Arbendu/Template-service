// ----------‐---------------------
// dto/diff/DiffNodeDto.java
// --------------------------------


package com.tcs.fincore.CommonRequestService.dto.diff;

import lombok.*;

@Getter
@Setter
@AllArgsConstructor
@NoArgsConstructor
@Builder
public class DiffNodeDto {
    private String path;          // JSON path
    private DiffType changeType;
    private Object oldValue;
    private Object newValue;
}



// -----------------------------------
// dto/diff/DiffResponseDto.java
// ------------------------------------


package com.tcs.fincore.CommonRequestService.dto.diff;

import lombok.*;

import java.util.List;

@Getter
@Setter
@AllArgsConstructor
@NoArgsConstructor
@Builder
public class TemplateDiffResponseDto {

    private Object oldTemplate;   // pruned version
    private Object newTemplate;   // pruned version
    private List<DiffNodeDto> diffs;
}



// -------------------------------------
// util/JsonDiffUtil.java
// --------------------------------------


package com.tcs.fincore.CommonRequestService.util;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.tcs.fincore.CommonRequestService.dto.diff.*;

import java.util.*;

public class JsonDiffUtil {

    private static final ObjectMapper MAPPER = new ObjectMapper();

    public static TemplateDiffResponseDto diff(Object oldObj, Object newObj) {

        ObjectNode oldNode = MAPPER.valueToTree(oldObj);
        ObjectNode newNode = MAPPER.valueToTree(newObj);

        List<DiffNodeDto> diffs = new ArrayList<>();

        ObjectNode oldPruned = MAPPER.createObjectNode();
        ObjectNode newPruned = MAPPER.createObjectNode();

        compare("", oldNode, newNode, diffs, oldPruned, newPruned);

        return TemplateDiffResponseDto.builder()
                .oldTemplate(oldPruned)
                .newTemplate(newPruned)
                .diffs(diffs)
                .build();
    }

    private static void compare(
            String path,
            ObjectNode oldNode,
            ObjectNode newNode,
            List<DiffNodeDto> diffs,
            ObjectNode oldOut,
            ObjectNode newOut
    ) {

        Set<String> allFields = new HashSet<>();
        oldNode.fieldNames().forEachRemaining(allFields::add);
        newNode.fieldNames().forEachRemaining(allFields::add);

        for (String field : allFields) {
            String currentPath = path.isEmpty() ? field : path + "." + field;

            if (!oldNode.has(field)) {
                diffs.add(new DiffNodeDto(currentPath, DiffType.ADD, null, newNode.get(field)));
                newOut.set(field, newNode.get(field));
            }
            else if (!newNode.has(field)) {
                diffs.add(new DiffNodeDto(currentPath, DiffType.DELETE, oldNode.get(field), null));
                oldOut.set(field, oldNode.get(field));
            }
            else if (!oldNode.get(field).equals(newNode.get(field))) {

                if (oldNode.get(field).isObject() && newNode.get(field).isObject()) {
                    ObjectNode o = MAPPER.createObjectNode();
                    ObjectNode n = MAPPER.createObjectNode();
                    compare(currentPath,
                            (ObjectNode) oldNode.get(field),
                            (ObjectNode) newNode.get(field),
                            diffs, o, n);
                    if (!o.isEmpty()) oldOut.set(field, o);
                    if (!n.isEmpty()) newOut.set(field, n);
                } else {
                    diffs.add(new DiffNodeDto(
                            currentPath,
                            DiffType.UPDATE,
                            oldNode.get(field),
                            newNode.get(field)
                    ));
                    oldOut.set(field, oldNode.get(field));
                    newOut.set(field, newNode.get(field));
                }
            }
        }
    }
}







// -----------------------‐-----------
// service/TemplateDiffService.java
// ----------------------------------------------


package com.tcs.fincore.CommonRequestService.service;

import com.tcs.fincore.CommonRequestService.dto.diff.TemplateDiffResponseDto;
import com.tcs.fincore.CommonRequestService.model.enums.RequestType;

public interface TemplateDiffService {
    TemplateDiffResponseDto diffTemplate(Long requestId, RequestType requestType);
}




// -----------------------‐-----------
// service/impl/TemplateDiffServiceImpl.java
// ----------------------------------------------


package com.tcs.fincore.CommonRequestService.service.impl;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.tcs.fincore.CommonRequestService.dto.ReportTemplateDto;
import com.tcs.fincore.CommonRequestService.dto.diff.TemplateDiffResponseDto;
import com.tcs.fincore.CommonRequestService.model.CommonReq;
import com.tcs.fincore.CommonRequestService.model.ReportTemplate;
import com.tcs.fincore.CommonRequestService.model.enums.RequestType;
import com.tcs.fincore.CommonRequestService.repository.CommonRequestRepository;
import com.tcs.fincore.CommonRequestService.repository.ReportTemplateRepository;
import com.tcs.fincore.CommonRequestService.service.TemplateDiffService;
import com.tcs.fincore.CommonRequestService.util.JsonDiffUtil;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class TemplateDiffServiceImpl implements TemplateDiffService {

    private final CommonRequestRepository commonRequestRepository;
    private final ReportTemplateRepository reportTemplateRepository;
    private final ObjectMapper objectMapper;

    @Override
    public TemplateDiffResponseDto diffTemplate(Long requestId, RequestType requestType) {

        if (requestType != RequestType.RB_REPORT_TEMPLATE) {
            throw new IllegalArgumentException("Diff supported only for RB_REPORT_TEMPLATE");
        }

        CommonReq request = commonRequestRepository.findById(requestId)
                .orElseThrow(() -> new IllegalArgumentException("Request not found"));

        // NEW TEMPLATE (from payload)
        ReportTemplateDto newTemplate =
                objectMapper.convertValue(request.getPayload(), ReportTemplateDto.class);

        // OLD TEMPLATE (from active DB version)
        ReportTemplate oldTemplateEntity =
                reportTemplateRepository.findFirstByReportIdAndStatus(
                        newTemplate.getTemplate().getReportMeta().getReportId(),
                        "ACTIVE"
                ).orElseThrow(() -> new IllegalStateException("Active template not found"));

        ReportTemplateDto.Template oldTemplate =
                objectMapper.readValue(oldTemplateEntity.getTemplateJson(),
                        ReportTemplateDto.Template.class);

        return JsonDiffUtil.diff(oldTemplate, newTemplate.getTemplate());
    }
}



// -----------------------------------------
 // controller/TemplateDiffController.java
// -------------------------------------------


package com.tcs.fincore.CommonRequestService.controller;

import com.tcs.fincore.CommonRequestService.dto.diff.TemplateDiffResponseDto;
import com.tcs.fincore.CommonRequestService.model.enums.RequestType;
import com.tcs.fincore.CommonRequestService.service.TemplateDiffService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/template-diff")
@RequiredArgsConstructor
public class TemplateDiffController {

    private final TemplateDiffService templateDiffService;

    @GetMapping
    public TemplateDiffResponseDto getTemplateDiff(
            @RequestParam Long requestId,
            @RequestParam RequestType requestType
    ) {
        return templateDiffService.diffTemplate(requestId, requestType);
    }
}
